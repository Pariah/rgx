#!/bin/bash
set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Block force pushes (detect non-fast-forward)
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" != "0000000000000000000000000000000000000000" ] && \
       [ "$remote_sha" != "0000000000000000000000000000000000000000" ]; then
        if ! git merge-base --is-ancestor "$remote_sha" "$local_sha" 2>/dev/null; then
            echo "âŒ Force push blocked (non-fast-forward to $remote_ref)"
            echo "   Use --force-with-lease if you really mean it."
            exit 1
        fi
    fi
done

echo "ğŸ” Pre-push: verifying quality..."

echo "  â†’ Checking clippy..."
cargo clippy -- -D warnings

echo "  â†’ Running tests..."
cargo test

echo "  â†’ Checking compilation..."
cargo check

echo "âœ… All checks passed!"
